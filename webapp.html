<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ü–æ—Ä—Ç—Ñ–µ–ª—å</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light theme background */
            color: #333; /* Light theme text color */
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 1rem; /* Add some padding around the content */
            box-sizing: border-box;
        }

        /* Dark theme styles */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a202c; /* Dark theme background */
                color: #e2e8f0; /* Dark theme text color */
            }
            .card {
                background-color: #2d3748; /* Darker card background for dark theme */
            }
            .text-gray-700 {
                color: #cbd5e0; /* Adjust dark theme text color for better contrast */
            }
            .shadow-md {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12); /* Darker shadow */
            }
            .btn-primary {
                background-color: #4c51bf; /* Darker blue for primary button in dark theme */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
            }
            .btn-primary:hover {
                background-color: #434190;
            }
        }

        .container {
            max-width: 600px;
            width: 100%;
            margin: auto; /* Center the container */
        }

        .card {
            background-color: #ffffff; /* Light theme card background */
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">
    <div class="container p-4">
        <h1 class="text-3xl font-bold text-center mb-6">üìä –ú–æ–π –ü–æ—Ä—Ç—Ñ–µ–ª—å</h1>

        <div id="portfolio-summary" class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-center">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h2>
            <div class="flex flex-col items-center justify-center space-y-2">
                <p class="text-4xl font-bold text-blue-600" id="total-balance-display">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                <p class="text-sm text-gray-500">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ USD</p>
            </div>
        </div>

        <div id="crypto-balances" class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-center">–ë–∞–ª–∞–Ω—Å—ã –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º</h2>
            <ul id="balances-list" class="space-y-2">
                <!-- Balances will be loaded here by JavaScript -->
                <li class="text-gray-700">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤...</li>
            </ul>
        </div>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full">
            <button id="deposit-button" class="btn-primary flex-1">
                <i class="fas fa-arrow-up mr-2"></i> –ü–æ–ø–æ–ª–Ω–∏—Ç—å –ë–∞–ª–∞–Ω—Å
            </button>
            <button id="withdraw-button" class="btn-primary flex-1">
                <i class="fas fa-arrow-down mr-2"></i> –ó–∞–ø—Ä–æ—Å–∏—Ç—å –í—ã–ø–ª–∞—Ç—É
            </button>
        </div>
    </div>

    <script>
        let webAppCheckInterval; // Declare a variable to hold the interval ID

        // Function to encapsulate WebApp logic
        function initializeWebApp() {
            // Check if Telegram WebApp API is available
            if (window.Telegram && window.Telegram.WebApp) {
                // Clear the interval as WebApp is ready
                clearInterval(webAppCheckInterval);

                Telegram.WebApp.ready(); // Inform Telegram WebApp that the page is ready
                Telegram.WebApp.expand(); // Expand the WebApp to full height

                console.log("Telegram WebApp API is ready and initialized.");

                // Get initial data passed from the bot (if any)
                const urlParams = new URLSearchParams(window.location.search);
                const initialBalancesEncoded = urlParams.get('initial_balances');
                let initialBalances = {};

                if (initialBalancesEncoded) {
                    try {
                        const decodedBalances = decodeURIComponent(initialBalancesEncoded);
                        initialBalances = JSON.parse(atob(decodedBalances));
                        console.log('Initial balances loaded:', initialBalances);
                    } catch (e) {
                        console.error("Error decoding or parsing initial balances:", e);
                        initialBalances = {};
                    }
                } else {
                    console.log("No initial balances provided in URL.");
                }

                // Function to display balances
                function displayBalances(balances) {
                    const balancesList = document.getElementById('balances-list');
                    balancesList.innerHTML = ''; // Clear existing list

                    let totalUSD = 0;
                    const cryptoPrices = {
                        'BTC': 70000, // Placeholder, ideally fetch live or get from bot
                        'ETH': 3500,  // Placeholder
                        'TON': 7.5,   // Placeholder
                        'USDT': 1.0    // Stablecoin
                    };

                    async function fetchPrices() {
                        try {
                            const response = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,tether,toncoin");
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const data = await response.json();
                            data.forEach(coin => {
                                if (coin.symbol === 'btc') cryptoPrices['BTC'] = coin.current_price;
                                if (coin.symbol === 'eth') cryptoPrices['ETH'] = coin.current_price;
                                if (coin.symbol === 'ton') cryptoPrices['TON'] = coin.current_price;
                                if (coin.symbol === 'usdt') cryptoPrices['USDT'] = coin.current_price;
                            });
                            console.log("Fetched live prices:", cryptoPrices);
                        } catch (error) {
                            console.error("Error fetching live crypto prices:", error);
                            // Fallback to placeholders if API call fails
                        }
                    }

                    fetchPrices().then(() => {
                        for (const crypto in balances) {
                            const amount = parseFloat(balances[crypto]);
                            const price = cryptoPrices[crypto] || 0;
                            const valueUSD = amount * price;

                            totalUSD += valueUSD;

                            const listItem = document.createElement('li');
                            listItem.className = 'flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-3 rounded-md shadow-sm';
                            listItem.innerHTML = `
                                <span class="font-medium text-lg">${crypto}:</span>
                                <span class="font-bold text-blue-700 dark:text-blue-300">${amount.toFixed(8)}</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400">($${valueUSD.toFixed(2)})</span>
                            `;
                            balancesList.appendChild(listItem);
                        }
                        document.getElementById('total-balance-display').textContent = `$${totalUSD.toFixed(2)}`;
                    });
                }

                // Display initial balances if available
                if (Object.keys(initialBalances).length > 0) {
                    displayBalances(initialBalances);
                } else {
                    document.getElementById('balances-list').innerHTML = '<li class="text-gray-700 dark:text-gray-300 text-center">–ë–∞–ª–∞–Ω—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –±–æ—Ç–∞.</li>';
                    document.getElementById('total-balance-display').textContent = 'N/A';
                }

                // Function to send data back to the bot
                function sendCommandToBot(actionType) {
                    if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.sendData(JSON.stringify({ action: actionType }));
                        console.log(`Command sent: ${actionType}`);
                    } else {
                        console.error("Telegram WebApp object not found during sendData attempt.");
                    }
                }

                // Attach event listeners to buttons
                document.getElementById('deposit-button').addEventListener('click', () => {
                    sendCommandToBot('start_deposit_flow');
                });

                document.getElementById('withdraw-button').addEventListener('click', () => {
                    sendCommandToBot('start_withdraw_flow');
                });

            } else {
                // If WebApp API is not available after interval, show an error message.
                document.body.innerHTML = `
                    <div class="container p-4 text-center mt-8">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">–û—à–∏–±–∫–∞: Telegram WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.</h1>
                        <p class="text-gray-700 dark:text-gray-300">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä Telegram WebApp.</p>
                    </div>
                `;
                console.error("Telegram WebApp object not found after multiple checks.");
            }
        }

        // Check for Telegram WebApp object every 100ms until it's ready
        webAppCheckInterval = setInterval(() => {
            if (window.Telegram && window.Telegram.WebApp) {
                initializeWebApp();
            } else {
                console.log("Waiting for Telegram WebApp object...");
            }
        }, 100);

        // Fallback for extremely slow loading or if WebApp never becomes available
        setTimeout(() => {
            if (!window.Telegram || !window.Telegram.WebApp) {
                clearInterval(webAppCheckInterval); // Stop trying
                initializeWebApp(); // Show the error message
            }
        }, 5000); // Wait up to 5 seconds before giving up and showing error
    </script>
</body>
</html>
